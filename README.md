# 3p
CSC_COMPLIANCE_REPORTING_ONS_DENORMALIZED_TBL_Enterprise :---->cr1  
---------------------------------------------------------
spark.sql("Create or Replace temp View cr_ons_fscsoli as SELECT DISTINCT case when (fssoli.Legacy_Company_Code = 'USM0' or fssoli.Source_System_Key>=8000) then 'FED' else 'NONFED' end as order_fed_qualification,sotyp.Sales_Order_Type_Key,sotyp.Sales_Order_Type_Code,sotyp.Sales_Order_Type_Description,CASE when fssoli.Sales_Order_Trade_Intercompany_Indicator ='Trade' then 'Y' else 'N' end AS Sales_Order_Type_Trade_Revenue_Flag,sotyp.Sales_Order_Type_Quota_Credit_Flag,fssoli.Supply_Chain_Sales_Order_Line_Item_Key,fssoli.Legacy_Business_Area_Code,dmeml.Material_Product_Line_Code as Sales_Order_Source_System_Product_Line_Id,fssoli.Sales_Order_Unit_Price_Sales_Order_Document_Amount,fssoli.Sales_Order_Item_Plant_Code,fssoli.Sales_Order_Header_Customer_Required_Delivery_Date,fssoli.Sales_Order_Detail_Bundle_Type_Code,fssoli.Customer_Product_ID,fssoli.Sales_Order_End_Customer_Locator_Id,fssoli.Sales_Order_End_Customer_Relationship_Profile_Id,fssoli.Sales_Order_Line_Cancel_Date,dmpl.Plant_Code as Sales_Order_Plant_Description,          fssoli.Sales_Order_Reference_Model_Id,fssoli.Sales_Order_End_Customer_Customer_Reference_Server_Id, dmeml.Material_Product_Line_Description as Sales_Order_Source_System_Product_Description ,fssoli.Sales_Order_Supplying_Division_Sub_Entity_Code,fssoli.Sales_Order_Sales_Channel_Code,fssoli.Sales_Order_Item_Material_Account_Assignment_Group_Code,fssoli.Sales_Order_Business_Dunning_Block_Code, CASE WHEN fssoli.Sales_Order_Item_Ship_To_Country_Code IS NULL OR TRIM(fssoli.Sales_Order_Item_Ship_To_Country_Code)='' THEN '?' ELSE fssoli.Sales_Order_Item_Ship_To_Country_Code END as Sales_Order_Item_Ship_To_Country_Code   ,fssoli.Sales_Order_Payer_Company_Cutomer_Id,fssoli.Sales_Order_Direct_Customer_Indicator_Code,fssoli.Sales_Order_Distribution_Channel_Code FROM TERA_CSC.fact_enterprise_supply_chain_order_detail fssoli left join TERA_CSC.DIM_ENTERPRISE_SALES_ORDER_TYPE_WORKING sotyp on fssoli.Sales_Order_Type_Key=sotyp.Sales_Order_Type_Key left join TERA_CSC.Dim_Plant dmpl on dmpl.Plant_Code=fssoli.Sales_Order_Item_Plant_Code left join TERA_CSC.dim_enterprise_material dmeml on dmeml.Material_Number =fssoli.Product_Id")

spark.sql("Create or Replace temp View cr_ons_fscsosli as SELECT DISTINCT case when fsosli.Sales_Order_Source_System_Key>=8000 then 'FED' else 'NONFED' END as shipment_fed_qualification,fsosli.Order_Line_Item_Key,fsosli.Shipment_Line_Item_Key,fsosli.Shipment_Line_Item_Id,trim(fsosli.Shipment_Id) as Shipment_Id, trim(fsosli.Sales_Order_Id) as Sales_Order_Id,cast(fsosli.Sales_Order_Line_Item_Id as int ) as Sales_Order_Line_Item_Id,CASE WHEN fsosli.Product_Id IS NULL OR TRIM(fsosli.Product_Id)='' THEN '?' ELSE fsosli.Product_Id END as Product_Id, case when instr(fsosli.Product_Id,'#') > 1 then substr(fsosli.Product_Id,1,instr(fsosli.Product_Id,'#')-1) else fsosli.Product_Id end as Product_id_without_localization ,fsosli.Shipment_Date, concat(substring (string (fsosli.shipment_date), 1,4),substring (string (fsosli.shipment_date), 6,2),'00') Ship_Year_Month_Identifier,concat(substring (string (fsosli.Sales_Order_Create_Date), 1,4),substring (string (fsosli.Sales_Order_Create_Date), 6,2),'00') Order_Year_Month_Identifier,fsosli.Shipment_Billing_Document_Id,fsosli.Shipment_Base_Quantity,fsosli.Sales_Order_Legacy_Profit_Center_Code,fsosli.Sales_Order_End_Customer_Id,fsosli.Sales_Order_Record_Explosion_Code,fsosli.Sales_Order_Gross_US_Dollar_Amount,fsosli.Shipment_Item_Plant_Code,fsosli.Shipment_Item_Legacy_Plant_Code,fsosli.Shipment_Header_Delivery_Type_Code,fsosli.Shipment_Header_Inbound_Transport_Means_Type_Code,fsosli.Shipment_Header_Transportation_Route_Duration_Code,fsosli.Sales_Order_Sales_Geography_Code,fsosli.Original_Product_Id,fsosli.Shipment_Third_Party_Product_Id,case when fsosli.Shipment_Return_Item_Flag In ('X','Y') then 'Y' else case when fsosli.Shipment_Return_Item_Flag='N' then 'N' else 'N' end end as Shipment_Return_Item_Flag,CASE WHEN fsosli.Shipment_Header_Proof_Of_Delivery_Date IS NULL OR TRIM(fsosli.Shipment_Header_Proof_Of_Delivery_Date)='' OR fsosli.Shipment_Header_Proof_Of_Delivery_Date='?' or fsosli.Shipment_Header_Proof_Of_Delivery_Date='9999-12-31' or fsosli.Shipment_Header_Proof_Of_Delivery_Date='1900-01-01' THEN b.Delivery_Events_Event_End_Time ELSE fsosli.Shipment_Header_Proof_Of_Delivery_Date end as Shipment_Header_Proof_Of_Delivery_Date FROM TERA_CSC.fact_enterprise_supply_chain_order_shipment_detail fsosli LEFT join TERA_CSC.Fact_Delivery_Events b on fsosli.Delivery_Item_Handle_For_Time_Segment_Header=b.Delivery_Events_Handle_For_Time_Segment_Header")

spark.sql("Create or Replace temp View cr_ons_cscons as select CURRENT_TIMESTAMP() as Insert_GMT_Timestamp,CURRENT_TIMESTAMP() As Source_System_Update_Timestamp,cr_ons_fscsosli.*,cr_ons_fscsoli.* from cr_ons_fscsoli inner join cr_ons_fscsosli on cr_ons_fscsoli.Supply_Chain_Sales_Order_Line_Item_Key = cr_ons_fscsosli.Order_Line_Item_Key where cr_ons_fscsosli.Ship_Year_Month_Identifier='20220200'")

---------------------------------------------------------------------
CSC_COMPLIANCE_REPORTING_PARTPRODUCT_ONS_DENORMALIZED_TBL_Enterprise :--->cr2
---------------------------------------------------------------------
spark.sql("Create or Replace temp View cr_partproduct_reporting_not_exist_in_bom as SELECT DISTINCT cppc.Insert_GMT_Timestamp,cppc.Source_System_Update_Timestamp,cppc.shipment_fed_qualification, cppc.Order_Line_Item_Key, cppc.Shipment_Line_Item_Key, cppc.Shipment_Line_Item_Id, cppc.Shipment_Id, cppc.Sales_Order_Id, cppc.Sales_Order_Line_Item_Id, CASE WHEN cppc.Product_Id IS NULL OR TRIM(cppc.Product_Id)='' THEN '?' ELSE cppc.Product_Id END as Product_Id,cppc.Product_id_without_localization, cppc.Shipment_Date, cppc.Ship_Year_Month_Identifier, cppc.Order_Year_Month_Identifier, cppc.Shipment_Billing_Document_Id, cppc.Shipment_Base_Quantity, cppc.Sales_Order_Legacy_Profit_Center_Code, cppc.Sales_Order_End_Customer_Id, cppc.Sales_Order_Record_Explosion_Code, cppc.Sales_Order_Gross_US_Dollar_Amount as Sales_Order_GrossUSDollarAmount, cppc.Shipment_Item_Plant_Code, cppc.Shipment_Item_Legacy_Plant_Code, cppc.Shipment_Header_Delivery_Type_Code, cppc.Shipment_Header_Inbound_Transport_Means_Type_Code, cppc.Shipment_Header_Transportation_Route_Duration_Code, cppc.Sales_Order_Sales_Geography_Code, cppc.Original_Product_Id, cppc.Shipment_Third_Party_Product_Id, cppc.Shipment_Return_Item_Flag, cppc.Shipment_Header_Proof_Of_Delivery_Date ,cppc.order_fed_qualification, cppc.Sales_Order_Type_Key, cppc.Sales_Order_Type_Code, cppc.Sales_Order_Type_Description, cppc.Sales_Order_Type_Trade_Revenue_Flag, cppc.Sales_Order_Type_Quota_Credit_Flag, cppc.Supply_Chain_Sales_Order_Line_Item_Key, cppc.Legacy_Business_Area_Code,cppc.Sales_Order_Source_System_Product_Line_Id,  cppc.Sales_Order_Unit_Price_Sales_Order_Document_Amount as Sales_Order_UnitPriceSalesOrderDocumentAmount, cppc.Sales_Order_Item_Plant_Code, cppc.Sales_Order_Header_Customer_Required_Delivery_Date, cppc.Sales_Order_Detail_Bundle_Type_Code, cppc.Customer_Product_Id, cppc.Sales_Order_End_Customer_Locator_Id, cppc.Sales_Order_End_Customer_Relationship_Profile_Id, cppc.Sales_Order_Line_Cancel_Date,cppc.Sales_Order_Plant_Description,  cppc.Sales_Order_Reference_Model_Id, cppc.Sales_Order_End_Customer_Customer_Reference_Server_Id,cppc.Sales_Order_Source_System_Product_Description,  cppc.Sales_Order_Supplying_Division_Sub_Entity_Code, cppc.Sales_Order_Sales_Channel_Code, cppc.Sales_Order_Item_Material_Account_Assignment_Group_Code ,cppc.Sales_Order_Business_Dunning_Block_Code,CASE WHEN cppc.Sales_Order_Item_Ship_To_Country_Code IS NULL OR TRIM(cppc.Sales_Order_Item_Ship_To_Country_Code)='' THEN '?' ELSE cppc.Sales_Order_Item_Ship_To_Country_Code END as Sales_Order_Item_Ship_To_Country_Code, cppc.Sales_Order_Payer_Company_Cutomer_Id, cppc.Sales_Order_Direct_Customer_Indicator_Code, cppc.Sales_Order_Distribution_Channel_Code , '?'  as BOM_Material_Nr,cast('0' as int) as BOM_Hierarchical_Level,'?' as Component_Material_Number,'?'  as BOM_Plant_Cd,'?'  as BOM_Usage_Cd,'?'  as BOM_Component_Nr,cast('0' as double)  as BOM_Component_Qty,cast('1900-01-01' as date)  as Bill_Of_Material_Valid_To_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Item_Valid_From_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Data_Valid_From_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Data_Valid_To_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Header_Valid_From_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Material_Create_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Material_Last_Change_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Item_Create_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Item_Last_Change_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Header_Create_Date,cast('1900-01-01' as date)  as Bill_Of_Material_Zload_Date, cast('0' as smallint)  as BOM_Alternative_Item_Usage_Probability_Percent,'?' as BOM_Status_Nr, cast('0' as int)  as BOM_Yr_Mnth_ID  FROM TERA_CSC.CSC_COMPLIANCE_REPORTING_ONS_DENORMALIZED_TBL_enterprise cppc WHERE NOT EXISTS (SELECT  1 FROM TERA_CSC.Dim_Hierarchical_Bill_Of_Material_Engineeringbom DBOM WHERE cppc.Product_id = DBOM.Sellable_Product_ID) and cppc.Ship_Year_Month_Identifier ='20220200'")

spark.sql("Create or Replace temp View cr_partproduct_reporting_not_exist_in_bom_ranking as SELECT * FROM (SELECT *, row_number() over (partition by Ship_Year_Month_Identifier,Order_Line_Item_Key order by Ship_Year_Month_Identifier,Order_Line_Item_Key DESC) rank_num FROM cr_partproduct_reporting_not_exist_in_bom) tmp")
  
spark.sql("Create or Replace temp View cr_partproduct_reporting_not_exist_in_bom_calculated as SELECT *,CASE When rank_num =1 then Shipment_Base_Quantity ELSE 0 END AS Calculated_Shipment_Base_Quantity, CASE When rank_num =1 then Sales_Order_UnitPriceSalesOrderDocumentAmount ELSE 0 END AS Sales_Order_Unit_Price_Sales_Order_Document_Amount, CASE When rank_num =1 then Sales_Order_GrossUSDollarAmount ELSE 0 END AS Sales_Order_Gross_US_Dollar_Amount  FROM cr_partproduct_reporting_not_exist_in_bom_ranking order by Product_id")

spark.table("cr_partproduct_reporting_not_exist_in_bom_calculated").write.format("delta").mode("append").partitionBy("Ship_Year_Month_Identifier").save("abfss://reportzone@ebproebiadls.dfs.core.windows.net/supplychain/orders_and_shipments/csc/delta/csc_cr_partproduct_bom_denormalized_tbl_enterprise ")

for row_ons in df_partproduct_ons:
  spark.sql("Create or Replace temp View cr_partproduct_reporting as SELECT DISTINCT cppc.Insert_GMT_Timestamp,cppc.Source_System_Update_Timestamp,cppc.shipment_fed_qualification, cppc.Order_Line_Item_Key, cppc.Shipment_Line_Item_Key, cppc.Shipment_Line_Item_Id, cppc.Shipment_Id, cppc.Sales_Order_Id, cppc.Sales_Order_Line_Item_Id,CASE WHEN cppc.Product_Id IS NULL OR TRIM(cppc.Product_Id)='' THEN '?' ELSE cppc.Product_Id END as Product_Id,cppc.Product_id_without_localization, cppc.Shipment_Date, cppc.Ship_Year_Month_Identifier, cppc.Order_Year_Month_Identifier, cppc.Shipment_Billing_Document_Id, cppc.Shipment_Base_Quantity, cppc.Sales_Order_Legacy_Profit_Center_Code, cppc.Sales_Order_End_Customer_Id, cppc.Sales_Order_Record_Explosion_Code, cppc.Sales_Order_Gross_US_Dollar_Amount as Sales_Order_GrossUSDollarAmount, cppc.Shipment_Item_Plant_Code, cppc.Shipment_Item_Legacy_Plant_Code, cppc.Shipment_Header_Delivery_Type_Code, cppc.Shipment_Header_Inbound_Transport_Means_Type_Code, cppc.Shipment_Header_Transportation_Route_Duration_Code, cppc.Sales_Order_Sales_Geography_Code, cppc.Original_Product_Id, cppc.Shipment_Third_Party_Product_Id, cppc.Shipment_Return_Item_Flag, cppc.Shipment_Header_Proof_Of_Delivery_Date ,cppc.order_fed_qualification, cppc.Sales_Order_Type_Key, cppc.Sales_Order_Type_Code, cppc.Sales_Order_Type_Description, cppc.Sales_Order_Type_Trade_Revenue_Flag, cppc.Sales_Order_Type_Quota_Credit_Flag, cppc.Supply_Chain_Sales_Order_Line_Item_Key, cppc.Legacy_Business_Area_Code,cppc.Sales_Order_Source_System_Product_Line_Id,  cppc.Sales_Order_Unit_Price_Sales_Order_Document_Amount as Sales_Order_UnitPriceSalesOrderDocumentAmount, cppc.Sales_Order_Item_Plant_Code, cppc.Sales_Order_Header_Customer_Required_Delivery_Date, cppc.Sales_Order_Detail_Bundle_Type_Code, cppc.Customer_Product_Id, cppc.Sales_Order_End_Customer_Locator_Id, cppc.Sales_Order_End_Customer_Relationship_Profile_Id, cppc.Sales_Order_Line_Cancel_Date,cppc.Sales_Order_Plant_Description,  cppc.Sales_Order_Reference_Model_Id, cppc.Sales_Order_End_Customer_Customer_Reference_Server_Id,  cppc.Sales_Order_Source_System_Product_Description,  cppc.Sales_Order_Supplying_Division_Sub_Entity_Code, cppc.Sales_Order_Sales_Channel_Code, cppc.Sales_Order_Item_Material_Account_Assignment_Group_Code ,cppc.Sales_Order_Business_Dunning_Block_Code, CASE WHEN cppc.Sales_Order_Item_Ship_To_Country_Code IS NULL OR TRIM(cppc.Sales_Order_Item_Ship_To_Country_Code)='' THEN '?' ELSE cppc.Sales_Order_Item_Ship_To_Country_Code END as Sales_Order_Item_Ship_To_Country_Code, cppc.Sales_Order_Payer_Company_Cutomer_Id, cppc.Sales_Order_Direct_Customer_Indicator_Code, cppc.Sales_Order_Distribution_Channel_Code ,DBOM.Bill_Of_Material_Material_Number  as BOM_Material_Nr,DBOM.Hierarchical_Level as BOM_Hierarchical_Level,DBOM.Bill_Of_Material_Component_Number as Component_Material_Number,DBOM.Bill_Of_Material_Plant_Code  as BOM_Plant_Cd,DBOM.Bill_Of_Material_Usage_Code  as BOM_Usage_Cd,CASE WHEN DBOM.Bill_Of_Material_Component_Number IS NULL OR TRIM(DBOM.Bill_Of_Material_Component_Number)='' THEN '?' ELSE DBOM.Bill_Of_Material_Component_Number END as BOM_Component_Nr,DBOM.Bill_Of_Material_Component_Quantity  as BOM_Component_Qty,DBOM.Bill_Of_Material_Valid_To_Date,DBOM.Bill_Of_Material_Item_Valid_From_Date,DBOM.Bill_Of_Material_Data_Valid_From_Date,DBOM.Bill_Of_Material_Data_Valid_To_Date,DBOM.Bill_Of_Material_Header_Valid_From_Date,DBOM.Bill_Of_Material_Material_Create_Date,DBOM.Bill_Of_Material_Material_Last_Change_Date,DBOM.Bill_Of_Material_Item_Create_Date,DBOM.Bill_Of_Material_Item_Last_Change_Date,DBOM.Bill_Of_Material_Header_Create_Date,DBOM.Bill_Of_Material_Zload_Date,DBOM.Bill_Of_Material_Alternative_Item_Usage_Probability_Percent  as BOM_Alternative_Item_Usage_Probability_Percent,DBOM.Bill_Of_Material_Status_Number as BOM_Status_Nr,DBOM.Year_Month_Identifier  as BOM_Yr_Mnth_ID FROM  TERA_CSC.CSC_COMPLIANCE_REPORTING_ONS_DENORMALIZED_TBL_enterprise cppc INNER JOIN    TERA_CSC.Dim_Hierarchical_Bill_Of_Material_Engineeringbom DBOM ON  cppc.Product_id = DBOM.Sellable_Product_ID where cppc.Ship_Year_Month_Identifier={}".format(row_ons["Ship_Year_Month_Identifier"]))
  
  spark.sql("Create or Replace temp View cr_partproduct_reporting_ranking as SELECT * FROM (SELECT *, row_number() over (partition by Ship_Year_Month_Identifier,Order_Line_Item_Key order by Ship_Year_Month_Identifier,Order_Line_Item_Key DESC) rank_num FROM cr_partproduct_reporting) tmp")
  
  spark.sql("Create or Replace temp View cr_partproduct_reporting_calculated as SELECT *,CASE When rank_num =1 then Shipment_Base_Quantity ELSE 0 END AS Calculated_Shipment_Base_Quantity, CASE When rank_num =1 then Sales_Order_UnitPriceSalesOrderDocumentAmount ELSE 0 END AS Sales_Order_Unit_Price_Sales_Order_Document_Amount, CASE When rank_num =1 then Sales_Order_GrossUSDollarAmount ELSE 0 END AS Sales_Order_Gross_US_Dollar_Amount  FROM cr_partproduct_reporting_ranking order by Product_id")
  
  print(row_ons["Ship_Year_Month_Identifier"])

  spark.table("cr_partproduct_reporting_calculated").write.format("delta").mode("append").partitionBy("Ship_Year_Month_Identifier").save("abfss://reportzone@ebproebiadls.dfs.core.windows.net/supplychain/orders_and_shipments/csc/delta/csc_cr_partproduct_bom_denormalized_tbl_enterprise ")
  
-------------------------------------------------------------
CSC_COMPLIANCE_REPORTING_DENORMALIZED_HISTORY_TBL_Enterprise ----->cr3
-------------------------------------------------------------
spark.sql('Create or Replace temporary View csc_snr as select fsoslisn.Shipment_Serial_Number_Id,fsoslisn.Sales_Order_Product_Id,case when instr(fsoslisn.Sales_Order_Product_Id,"#") > 1 then substr(fsoslisn.Sales_Order_Product_Id,1,instr(fsoslisn.Sales_Order_Product_Id,"#")-1) else fsoslisn.Sales_Order_Product_Id end as Sales_Order_Product_Id_without_localization,fsoslisn.shipment_date,fsoslisn.Sales_Order_Id,fsoslisn.Sales_Order_Line_Item_Id,fsoslisn.shipment_id from TERA_CSC.fact_enterprise_sales_order_shipment_line_item_serial_number fsoslisn')

spark.sql('create or Replace temporary View dssnt as select dssn.Serial_Number, dssn.Material_Number,case when instr(dssn.Material_Number,"#") > 1 then substr(dssn.Material_Number,1,instr(dssn.Material_Number,"#")-1) else dssn.Material_Number end as Material_Number_without_localization, dssn.shipment_date , dssn.Sales_Order_number , dssn.Shipment_Identifier , dssn.order_line_number, dssn.Serial_Number_Type_Code,dssn.Sales_Organization_Code,dssn.Source_System_Code,dssn.Updated_Date,dssn.Return_Date from  TERA_CSC.DIM_SHIPMENT_SERIAL_NUMBER dssn ')

spark.sql('create or Replace temporary View dusnt as select dusn.Serial_Number, dusn.Material_Number,case when instr(dusn.Material_Number,"#") > 1 then substr(dusn.Material_Number,1,instr(dusn.Material_Number,"#")-1) else dusn.Material_Number end as Material_Number_without_localization, dusn.Serial_Number_Type_Code , dusn.Plant_Code, dusn.Manufacture_Date , dusn.Production_Order_Number, dusn.Program_Type_Code,dusn.Localization_Option_Code, dusn.Sub_FA_Origin_Identifier,dusn.Hp_Unit_Serial_Number_Data_1_Text,dusn.Hp_Unit_Serial_Number_Data_2_Text,dusn.Hp_Unit_Serial_Number_Data_3_Text,dusn.Hp_Unit_Serial_Number_Data_4_Text,dusn.Unit_Of_Measure_Code, dusn.Returned_Flag,dusn.Remanufactured_Flag ,dusn.Active_Flag,dusn.Manufacturing_Date_Source,dusn.Software_BOM_Identifier from  TERA_CSC.DIM_UNIT_SERIAL_NUMBER dusn')
      
spark.sql("Create or Replace temporary View cr_cscsnr as SELECT coalesce(fsoslisn.Shipment_Serial_Number_Id,dssn.Serial_Number,dusn.Serial_Number) as Serial_Number,coalesce(fsoslisn.Sales_Order_Product_Id,dssn.Material_Number,dusn.Material_Number) as Material_Number,coalesce(fsoslisn.Sales_Order_Product_Id_without_localization,dssn.Material_Number_without_localization,dusn.Material_Number_without_localization) as Material_Number_without_localization,coalesce(fsoslisn.shipment_date,cast(dssn.shipment_date as date)) as Snr_Shipment_Date,coalesce(fsoslisn.Sales_Order_Id,dssn.Sales_Order_number) as Snr_Sales_Order_Id, coalesce(fsoslisn.Sales_Order_Line_Item_Id,dssn.order_line_number) as Snr_Sales_Order_Line_Item_Id,coalesce(fsoslisn.shipment_id, dssn.Shipment_Identifier) as Snr_Shipment_Id,coalesce(dssn.Serial_Number_Type_Code,dusn.Serial_Number_Type_Code) as Serial_Number_Type_Code,dssn.Sales_Organization_Code as Sales_Organization_Code,dssn.Source_System_Code as Source_System_Code,dssn.Updated_Date as Updated_Date,dssn.Return_Date as Return_Date,dusn.Plant_Code as Plant_Code,dusn.Manufacture_Date as Manufacture_Date,dusn.Production_Order_Number as Production_Order_Number,dusn.Program_Type_Code as Program_Type_Code,dusn.Localization_Option_Code as Localization_Option_Code,dusn.Sub_FA_Origin_Identifier as Sub_FA_Origin_Identifier,dusn.Hp_Unit_Serial_Number_Data_1_Text as Hp_Unit_Serial_Number_Data_1_Text,dusn.Hp_Unit_Serial_Number_Data_2_Text as Hp_Unit_Serial_Number_Data_2_Text,dusn.Hp_Unit_Serial_Number_Data_3_Text as Hp_Unit_Serial_Number_Data_3_Text,dusn.Hp_Unit_Serial_Number_Data_4_Text as Hp_Unit_Serial_Number_Data_4_Text,dusn.Unit_Of_Measure_Code as Unit_Of_Measure_Code,dusn.Returned_Flag as Returned_Flag,dusn.Remanufactured_Flag as Remanufactured_Flag,dusn.Active_Flag as Active_Flag,dusn.Manufacturing_Date_Source as Manufacturing_Date_Source_Code,dusn.Software_BOM_Identifier as Software_BOM_Identifier,cast(concat(Year(coalesce(fsoslisn.shipment_date,dssn.shipment_date)),lpad(month(coalesce(fsoslisn.shipment_date,dssn.shipment_date)),2,'0'),'00') as Int) as Year_Month_Identifier FROM csc_snr fsoslisn FULL OUTER JOIN dssnt dssn ON fsoslisn.shipment_id=dssn.Shipment_Identifier and fsoslisn.Sales_Order_Id=dssn.Sales_Order_number and fsoslisn.Sales_Order_Line_Item_Id=dssn.order_line_number and fsoslisn.Sales_Order_Product_Id_without_localization=dssn.Material_Number_without_localization and fsoslisn.Shipment_Serial_Number_Id= dssn.serial_number FULL OUTER JOIN dusnt dusn ON dusn.Material_Number_without_localization=dssn.Material_Number_without_localization and dusn.serial_number=dssn.serial_number")

# IQDC Component SNR Data
spark.sql("Create or Replace temporary View cr_csciqdc as SELECT DISTINCT fmupcsn.Manufactured_Unit_Profile_Product_Item_Identifier,fmupcsn.Manufactured_Unit_Profile_Product_Serial_Number,fmupcsn.Manufactured_Unit_Profile_Product_Number , case when instr(fmupcsn.Manufactured_Unit_Profile_Product_Number,'#') > 1 then substr(fmupcsn.Manufactured_Unit_Profile_Product_Number,1,instr(fmupcsn.Manufactured_Unit_Profile_Product_Number,'#')-1) else fmupcsn.Manufactured_Unit_Profile_Product_Number end as Manufactured_Unit_Profile_Product_Number_without_localization, fmupcsn.Manufactured_Unit_Profile_Product_Manufactuing_Site_Code,fmupcsn.Manufactured_Unit_Profile_Product_Build_Shift_Code,fmupcsn.Manufactured_Unit_Profile_Product_Completion_Timestamp,CASE WHEN fmupcsn.Manufactured_Unit_Profile_Component_Key IS NULL OR TRIM(fmupcsn.Manufactured_Unit_Profile_Component_Key)='' THEN '?' ELSE fmupcsn.Manufactured_Unit_Profile_Component_Key END as Manufactured_Unit_Profile_Component_Key         ,fmupcsn.Manufactured_Unit_Profile_Component_Assembly_Identifier,fmupcsn.Manufactured_Unit_Profile_Product_Shift_Completion_Timestamp,fmupcsn.Manufactured_Unit_Profile_Component_Component_Serial_Number,fmupcsn.Manufactured_Unit_Profile_Component_Component_Part_Number,fmupcsn.Manufactured_Unit_Profile_Component_Component_Revision_Code,fmupcsn.Manufactured_Unit_Profile_Component_Sub_Assembly_Manufacturing_Week_Date,fmupcsn.Manufactured_Unit_Profile_Component_Supplier_Code, CASE WHEN  fmupcsn.Manufactured_Unit_Profile_Product_Serial_Number_Key IS NULL OR TRIM( fmupcsn.Manufactured_Unit_Profile_Product_Serial_Number_Key)='' THEN '?' ELSE  fmupcsn.Manufactured_Unit_Profile_Product_Serial_Number_Key END as Manufactured_Unit_Profile_Product_Serial_Number_Key, CASE WHEN fmupcsn.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code IS NULL OR TRIM(fmupcsn.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code)='' THEN '?' ELSE fmupcsn.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code END as Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code, fmupcsn.Manufactured_Unit_Profile_Component_Status_Code,fmupcsn.Manufactured_Unit_Profile_Component_Component_Quantity FROM TERA_CSC.FACT_MANUFACTURED_UNIT_PROFILE_COMPONENT_SERIAL_NUMBER fmupcsn")



#Join SNR and IQDC
spark.sql("Create or Replace temporary View cr_cscsnriqdc as SELECT snr.*, iqdc.*, case when iqdc.Manufactured_Unit_Profile_Product_Serial_Number IS NOT NULL AND iqdc.Manufactured_Unit_Profile_Product_Number IS NOT NULL then 'Y' else 'N' end as Iqdc_Exists FROM cr_cscsnr snr LEFT JOIN cr_csciqdc iqdc ON snr.Serial_Number = iqdc.Manufactured_Unit_Profile_Product_Serial_Number AND snr.Material_Number_without_localization = iqdc.Manufactured_Unit_Profile_Product_Number_without_localization")


df_partproduct_ons = spark.sql("select Ship_Year_Month_Identifier,count(1) rec_cnt FROM TERA_CSC.CSC_COMPLIANCE_REPORTING_ONS_DENORMALIZED_TBL_enterprise where  Ship_Year_Month_Identifier>='20220200' group by Ship_Year_Month_Identifier order by Ship_Year_Month_Identifier ").rdd.collect()

for row_ons in df_partproduct_ons:
  print(row_ons["Ship_Year_Month_Identifier"])
  spark.sql("Create or Replace temporary View cr_csconssnriqdc as SELECT cr_ons.Insert_GMT_Timestamp,cr_ons.Source_System_Update_Timestamp,cr_ons.shipment_fed_qualification,cr_ons.Order_Line_Item_Key,cr_ons.Shipment_Line_Item_Key,cr_ons.Shipment_Line_Item_Id,cr_ons.Shipment_Id,cr_ons.Sales_Order_Id,cr_ons.Sales_Order_Line_Item_Id, CASE WHEN cr_ons.Product_Id IS NULL OR TRIM(cr_ons.Product_Id)='' THEN '?' ELSE cr_ons.Product_Id END AS Product_Id,CASE WHEN cr_ons.Product_id_without_localization IS NULL OR TRIM(cr_ons.Product_id_without_localization)='' THEN '?' ELSE cr_ons.Product_id_without_localization END AS Product_id_without_localization, cr_ons.Shipment_Date,cr_ons.Ship_Year_Month_Identifier,cr_ons.Order_Year_Month_Identifier,cr_ons.Shipment_Billing_Document_Id,cr_ons.Shipment_Base_Quantity,cr_ons.Sales_Order_Legacy_Profit_Center_Code,cr_ons.Sales_Order_End_Customer_Id,cr_ons.Sales_Order_Record_Explosion_Code,cr_ons.Sales_Order_Gross_US_Dollar_Amount,cr_ons.Shipment_Item_Plant_Code,cr_ons.Shipment_Item_Legacy_Plant_Code,cr_ons.Shipment_Header_Delivery_Type_Code,cr_ons.Shipment_Header_Inbound_Transport_Means_Type_Code,cr_ons.Shipment_Header_Transportation_Route_Duration_Code,cr_ons.Sales_Order_Sales_Geography_Code,cr_ons.Original_Product_Id,cr_ons.Shipment_Third_Party_Product_Id,cr_ons.Shipment_Return_Item_Flag,cr_ons.Shipment_Header_Proof_Of_Delivery_Date,cr_ons.order_fed_qualification,cr_ons.Sales_Order_Type_Key,cr_ons.Sales_Order_Type_Code,cr_ons.Sales_Order_Type_Description,cr_ons.Sales_Order_Type_Trade_Revenue_Flag,cr_ons.Sales_Order_Type_Quota_Credit_Flag,cr_ons.Supply_Chain_Sales_Order_Line_Item_Key,cr_ons.Legacy_Business_Area_Code,cr_ons.Sales_Order_Source_System_Product_Line_Id,cr_ons.Sales_Order_Unit_Price_Sales_Order_Document_Amount,cr_ons.Sales_Order_Item_Plant_Code,cr_ons.Sales_Order_Header_Customer_Required_Delivery_Date,cr_ons.Sales_Order_Detail_Bundle_Type_Code,cr_ons.Customer_Product_ID,cr_ons.Sales_Order_End_Customer_Locator_Id,cr_ons.Sales_Order_End_Customer_Relationship_Profile_Id,cr_ons.Sales_Order_Line_Cancel_Date,cr_ons.Sales_Order_Plant_Description,cr_ons.Sales_Order_Reference_Model_Id,cr_ons.Sales_Order_End_Customer_Customer_Reference_Server_Id,cr_ons.Sales_Order_Source_System_Product_Description,cr_ons.Sales_Order_Supplying_Division_Sub_Entity_Code,cr_ons.Sales_Order_Sales_Channel_Code,cr_ons.Sales_Order_Item_Material_Account_Assignment_Group_Code,cr_ons.Sales_Order_Business_Dunning_Block_Code,CASE WHEN cr_ons.Sales_Order_Item_Ship_To_Country_Code IS NULL OR TRIM(cr_ons.Sales_Order_Item_Ship_To_Country_Code)='' THEN '?' ELSE cr_ons.Sales_Order_Item_Ship_To_Country_Code END AS Sales_Order_Item_Ship_To_Country_Code, cr_ons.Sales_Order_Payer_Company_Cutomer_Id,cr_ons.Sales_Order_Direct_Customer_Indicator_Code,cr_ons.Sales_Order_Distribution_Channel_Code,  snriqdc.Serial_Number,snriqdc.Material_Number,snriqdc.Material_Number_without_localization,snriqdc.Snr_Shipment_Date,snriqdc.Snr_Sales_Order_Id,snriqdc.Snr_Sales_Order_Line_Item_Id,snriqdc.Snr_Shipment_Id,snriqdc.Serial_Number_Type_Code,snriqdc.Sales_Organization_Code,snriqdc.Source_System_Code,snriqdc.Updated_Date,snriqdc.Return_Date,snriqdc.Plant_Code,snriqdc.Manufacture_Date,snriqdc.Production_Order_Number,snriqdc.Program_Type_Code,snriqdc.Localization_Option_Code,snriqdc.Sub_FA_Origin_Identifier,snriqdc.Hp_Unit_Serial_Number_Data_1_Text,snriqdc.Hp_Unit_Serial_Number_Data_2_Text,snriqdc.Hp_Unit_Serial_Number_Data_3_Text,snriqdc.Hp_Unit_Serial_Number_Data_4_Text,snriqdc.Unit_Of_Measure_Code,snriqdc.Returned_Flag,snriqdc.Remanufactured_Flag,snriqdc.Active_Flag,snriqdc.Manufacturing_Date_Source_Code,snriqdc.Software_BOM_Identifier,snriqdc.Year_Month_Identifier,snriqdc.Manufactured_Unit_Profile_Product_Item_Identifier,snriqdc.Manufactured_Unit_Profile_Product_Serial_Number,snriqdc.Manufactured_Unit_Profile_Product_Number,snriqdc.Manufactured_Unit_Profile_Product_Number_without_localization,snriqdc.Manufactured_Unit_Profile_Product_Manufactuing_Site_Code,snriqdc.Manufactured_Unit_Profile_Product_Build_Shift_Code,snriqdc.Manufactured_Unit_Profile_Product_Completion_Timestamp,CASE WHEN snriqdc.Manufactured_Unit_Profile_Component_Key IS NULL OR TRIM(snriqdc.Manufactured_Unit_Profile_Component_Key)='' THEN '?' ELSE snriqdc.Manufactured_Unit_Profile_Component_Key END AS Manufactured_Unit_Profile_Component_Key,  snriqdc.Manufactured_Unit_Profile_Component_Assembly_Identifier,snriqdc.Manufactured_Unit_Profile_Product_Shift_Completion_Timestamp,snriqdc.Manufactured_Unit_Profile_Component_Component_Serial_Number,snriqdc.Manufactured_Unit_Profile_Component_Component_Part_Number,snriqdc.Manufactured_Unit_Profile_Component_Component_Revision_Code,snriqdc.Manufactured_Unit_Profile_Component_Sub_Assembly_Manufacturing_Week_Date,snriqdc.Manufactured_Unit_Profile_Component_Supplier_Code,CASE WHEN snriqdc.Manufactured_Unit_Profile_Product_Serial_Number_Key IS NULL OR TRIM(snriqdc.Manufactured_Unit_Profile_Product_Serial_Number_Key)='' THEN '?' ELSE snriqdc.Manufactured_Unit_Profile_Product_Serial_Number_Key END AS Manufactured_Unit_Profile_Product_Serial_Number_Key ,CASE WHEN snriqdc.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code IS NULL OR TRIM(snriqdc.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code)='' THEN '?' ELSE snriqdc.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code END AS Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code ,snriqdc.Manufactured_Unit_Profile_Component_Status_Code,snriqdc.Manufactured_Unit_Profile_Component_Component_Quantity,snriqdc.Iqdc_Exists, case when snriqdc.Iqdc_Exists ='Y' then 'Y' else 'N' end as Iqdc_Record_Exists_Flag FROM TERA_CSC.CSC_COMPLIANCE_REPORTING_ONS_DENORMALIZED_TBL_enterprise cr_ons LEFT JOIN cr_cscsnriqdc snriqdc ON cr_ons.Shipment_Id = snriqdc.Snr_Shipment_Id AND cr_ons.Sales_Order_Id = snriqdc.Snr_Sales_Order_Id AND  cr_ons.Product_Id_without_localization = snriqdc.Material_Number_without_localization AND cr_ons.Sales_Order_Line_Item_Id = snriqdc.Snr_Sales_Order_Line_Item_Id where cr_ons.Ship_Year_Month_Identifier={} order by cr_ons.Sales_Order_ID,cr_ons.Product_Id, cr_ons.Sales_Order_Item_Ship_To_Country_Code, snriqdc.Serial_Number, snriqdc.Material_Number, snriqdc.Manufactured_Unit_Profile_Component_Sub_Assembly_Type_Code, cr_ons.Product_Id_without_localization , snriqdc.Material_Number_without_localization, cr_ons.Order_Line_Item_Key".format(row_ons["Ship_Year_Month_Identifier"]))

  spark.table("cr_csconssnriqdc").write.format("delta").mode("append").partitionBy("Ship_Year_Month_Identifier").save("abfss://reportzone@ebproebiadls.dfs.core.windows.net/supplychain/orders_and_shipments/csc/delta/csc_compliance_reporting_denormalized_history_tbl_enterprise")



---------------------------------------------------------------------------  
CSC_COMPLIANCE_REPORTING_VIEW_TBL_Enterprise --->cr4
---------------------------------------------------------------------------
  df_cr_report_bom = spark.sql("select Ship_Year_Month_Identifier,count(1) rec_cnt FROM TERA_CSC.CSC_COMPLIANCE_REPORTING_VIEW_TBL_enterprise WHERE Ship_Year_Month_Identifier ='20220200'  group by Ship_Year_Month_Identifier order by Ship_Year_Month_Identifier desc").rdd.collect()
  
  for row_bom in df_cr_report_bom:
  print(row_bom["Ship_Year_Month_Identifier"])
  
  now = datetime.now()
  print("merge1 start time =", now)
   
  spark.sql("create OR replace temp view ship_quantity as SELECT a.Order_Line_Item_Key,a.Component_Material_Number, Count(1) as Denom FROM TERA_CSC.CSC_COMPLIANCE_REPORTING_VIEW_TBL_enterprise a WHERE a.Ship_Year_Month_Identifier={} group by a.Order_Line_Item_Key,a.Component_Material_Number".format(row_bom["Ship_Year_Month_Identifier"]))
  
  spark.sql("create OR replace temp view ship_quantity2 as SELECT a.Order_Line_Item_Key, Count(1) as DenomSQ FROM TERA_CSC.CSC_COMPLIANCE_REPORTING_VIEW_TBL_enterprise a where  a.Ship_Year_Month_Identifier={} group by a.Order_Line_Item_Key".format(row_bom["Ship_Year_Month_Identifier"]))
  
  spark.sql("merge into TERA_CSC.CSC_COMPLIANCE_REPORTING_VIEW_TBL_enterprise a using ship_quantity b on (a.Order_Line_Item_Key=b.Order_Line_Item_Key and a.Component_Material_Number=b.Component_Material_Number and (a.Denom =0 or a.Denom IS NULL or a.SQqty_CQLevel=0 or a.SQqty_CQLevel IS NULL ) and a.Ship_Year_Month_Identifier={} ) when matched then update set a.Denom=b.Denom, a.SQqty_CQLevel=(a.Shipment_Base_Quantity/b.Denom)".format(row_bom["Ship_Year_Month_Identifier"]))
  
  now = datetime.now()
  print("merge2 start time =", now)         
  spark.sql("merge into TERA_CSC.CSC_COMPLIANCE_REPORTING_VIEW_TBL_enterprise a using ship_quantity2 b on (a.Order_Line_Item_Key=b.Order_Line_Item_Key and (a.DenomSQ =0 or a.DenomSQ IS NULL or a.SQqty=0 or a.SQqty IS NULL ) and  a.Ship_Year_Month_Identifier={}) when matched then update set a.DenomSQ=b.DenomSQ, a.SQqty=(a.Shipment_Base_Quantity/b.DenomSQ)".format(row_bom["Ship_Year_Month_Identifier"]))
  
  now = datetime.now()
  print("country update start time =", now)
  spark.sql("merge into tera_csc.CSC_COMPLIANCE_REPORTING_VIEW_TBL_enterprise a using tera_csc.ship_to_rolespec_ranking_view b ON a.Sales_Order_Id = b.Business_Partner_Function_Sales_Order_Item_Sales_Order_Identifier and (a.Sales_Order_Item_Ship_To_Country_Code IS NULL or a.Sales_Order_Item_Ship_To_Country_Code ='?') and a.ship_year_month_identifier ={} when matched then update set a.Sales_Order_Item_Ship_To_Country_Code = b.Business_Partner_Function_Sales_Order_Item_Country_Code".format(row_bom["Ship_Year_Month_Identifier"]))
  
  
